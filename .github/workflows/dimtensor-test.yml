name: Test with dimtensor

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    name: Test on Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ['3.10', '3.11', '3.12']
        include:
          # Test on macOS and Windows with a single Python version
          - os: macos-latest
            python-version: '3.11'
          - os: windows-latest
            python-version: '3.11'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup dimtensor
        uses: ./.github/actions/setup-dimtensor
        with:
          python-version: ${{ matrix.python-version }}
          install-extras: 'dev,all'

      - name: Run tests with pytest
        run: |
          pytest --verbose --cov=dimtensor --cov-report=xml --cov-report=term-missing

      - name: Check for dimensional errors
        if: failure()
        run: |
          echo "::error::Tests failed - check for dimensional inconsistencies"
          exit 1

      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-py${{ matrix.python-version }}
          path: |
            coverage.xml
            .coverage
          retention-days: 30

      - name: Generate test badge
        if: success() && matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        run: |
          mkdir -p badges
          echo '{"schemaVersion": 1, "label": "tests", "message": "passing", "color": "success"}' > badges/test-badge.json

      - name: Upload badge
        if: success() && matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        uses: actions/upload-artifact@v4
        with:
          name: test-badge
          path: badges/test-badge.json

  test-minimal:
    name: Test minimal installation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup dimtensor
        uses: ./.github/actions/setup-dimtensor
        with:
          python-version: '3.11'
          install-extras: 'dev'

      - name: Run core tests only
        run: |
          pytest tests/test_dimarray.py tests/test_dimensions.py tests/test_units.py -v

      - name: Verify dimensional safety
        run: |
          python -c "
          from dimtensor import DimArray, units
          import numpy as np

          # Test basic operations
          x = DimArray([1, 2, 3], units.m)
          y = DimArray([4, 5, 6], units.s)

          # This should work
          z = x * y
          assert z.unit == units.m * units.s

          # This should raise DimensionError
          try:
              bad = x + y
              raise AssertionError('Should have raised DimensionError')
          except Exception as e:
              assert 'dimension' in str(e).lower()

          print('Dimensional safety verified!')
          "

  type-check:
    name: Type checking with mypy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup dimtensor
        uses: ./.github/actions/setup-dimtensor
        with:
          python-version: '3.11'
          install-extras: 'dev'

      - name: Run mypy
        run: |
          mypy src/dimtensor --ignore-missing-imports
