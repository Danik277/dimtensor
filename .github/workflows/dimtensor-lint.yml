name: Dimensional Linting

on:
  pull_request:
    paths:
      - '**.py'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    name: Lint dimensional consistency
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup dimtensor
        uses: ./.github/actions/setup-dimtensor
        with:
          python-version: '3.11'
          install-extras: 'dev'

      - name: Run dimensional linter
        id: lint
        run: |
          # Run linter and capture output
          python -m dimtensor lint . --format json > lint-results.json || true

          # Check if there are any warnings or errors
          if [ -s lint-results.json ]; then
            WARNINGS=$(python -c "import json; data=json.load(open('lint-results.json')); print(sum(1 for r in data if r['severity'] in ['warning', 'error']))")
            echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT

            if [ "$WARNINGS" -gt 0 ]; then
              echo "Found $WARNINGS dimensional issues"
              python -m dimtensor lint . --format text
              exit 1
            fi
          fi

          echo "No dimensional issues found"
          echo "warnings=0" >> $GITHUB_OUTPUT

      - name: Upload lint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-results
          path: lint-results.json
          retention-days: 30

      - name: Comment on PR
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('lint-results.json', 'utf8'));

            const warnings = results.filter(r => r.severity === 'warning');
            const errors = results.filter(r => r.severity === 'error');

            let comment = '## Dimensional Linting Results\n\n';

            if (errors.length > 0) {
              comment += `### ❌ Errors (${errors.length})\n\n`;
              errors.slice(0, 5).forEach(e => {
                comment += `- **${e.file}:${e.line}:${e.column}**: ${e.message}\n`;
              });
              if (errors.length > 5) {
                comment += `\n_...and ${errors.length - 5} more errors_\n`;
              }
              comment += '\n';
            }

            if (warnings.length > 0) {
              comment += `### ⚠️ Warnings (${warnings.length})\n\n`;
              warnings.slice(0, 5).forEach(w => {
                comment += `- **${w.file}:${w.line}:${w.column}**: ${w.message}\n`;
              });
              if (warnings.length > 5) {
                comment += `\n_...and ${warnings.length - 5} more warnings_\n`;
              }
            }

            comment += '\n---\nPlease fix these dimensional inconsistencies before merging.';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Generate badge data
        if: success()
        run: |
          mkdir -p badges
          echo '{"schemaVersion": 1, "label": "dimensional linting", "message": "passing", "color": "success"}' > badges/lint-badge.json

      - name: Upload badge
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: lint-badge
          path: badges/lint-badge.json
